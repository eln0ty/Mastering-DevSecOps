name: CI-Security-Gate
on: [push, pull_request]

jobs:
  static-security-checks:
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Checkout the repository
      - name: Checkout Repository
        uses: actions/checkout@v6.0.1
        with:
          fetch-depth: 0  # Full history for better secret detection

      # Step 2: Layer 1 - Secret Scanning with Gitleaks
      - name: 1. Secret Scanning (Gitleaks)
        run: |
          # Install Gitleaks
          wget https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz
          tar -xzf gitleaks_8.18.0_linux_x64.tar.gz
          chmod +x gitleaks
          ./gitleaks detect --source SAST/ -v

      # Step 3: Layer 2 - Dependency Vulnerability Scanning (SCA)
      - name: 2. Dependency Scan (SCA with Safety)
        run: |
          pip install safety
          # Scan all dependencies for known CVEs
          safety check -r SAST/requirements.txt

      # Step 4: Layer 3 - Custom Static Application Security Testing (SAST)
      - name: 3. Custom SAST (Bandit with Custom Rules)
        run: |
          # Install custom security rule package
          pip install ./SAST/security/
          # Run Bandit with custom B901 rule
          bandit -r SAST/src/ -ll -t B901